<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eyelearner (v1.3.1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Space+Mono&display=swap');
        :root { --bg: #050608; --panel: #0f1115; --sky: #38bdf8; --amber: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #f1f5f9; overflow-x: hidden; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: contain; }
        .eyean-font { font-family: 'Space Mono', monospace; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .confetti { position: fixed; width: 8px; height: 8px; top: -10px; border-radius: 2px; animation: fall linear forwards; z-index: 3000; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
        .drop-shadow-glow { filter: drop-shadow(0 0 15px rgba(56, 189, 248, 0.4)); }
        .verify-bar { background: rgba(5, 6, 8, 0.98); backdrop-filter: blur(24px); border-top: 1px solid rgba(255,255,255,0.1); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .word-chip { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .word-chip:active { transform: translateY(2px); background: var(--sky); color: #000; }
        .locked { filter: grayscale(1) opacity(0.3); pointer-events: none; }
        .badge-radiant { background: radial-gradient(circle, rgba(56,189,248,0.2) 0%, transparent 70%); animation: pulse-glow 3s infinite; }
        @keyframes pulse-glow { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } }
        .bounce-slow { animation: bounce 3s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="sticky top-0 z-[100] bg-[#050608]/95 backdrop-blur-lg border-b border-white/5 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center text-slate-950 font-black shadow-lg">E</div>
            <div>
                <span class="font-black tracking-tighter text-sm uppercase block">Eyelearner</span>
                <button onclick="toggleScript()" id="script-toggle" class="text-[10px] text-sky-400 font-bold uppercase tracking-widest opacity-80">Script: West</button>
            </div>
        </div>
        <div class="text-amber-500 font-black text-xs flex items-center gap-1">
            <i data-lucide="sparkles" class="w-4 h-4"></i> <span id="xp-val">0</span>
        </div>
    </header>

    <main id="app-content" class="flex-1 max-w-xl mx-auto w-full p-6 relative pb-32">
        <!-- Views injected here -->
    </main>

    <nav id="footer-nav" class="fixed bottom-0 left-0 right-0 bg-[#050608]/95 backdrop-blur-xl border-t border-white/5 px-6 py-4 flex justify-around items-center z-[90] pb-8">
        <button onclick="setView('path')" id="nav-path" class="flex flex-col items-center gap-1 transition-colors">
            <i data-lucide="map" class="w-6 h-6"></i><span class="text-[8px] font-black uppercase">Journey</span>
        </button>
        <button onclick="setView('translator')" id="nav-translator" class="flex flex-col items-center gap-1 transition-colors">
            <i data-lucide="languages" class="w-6 h-6"></i><span class="text-[8px] font-black uppercase">Translator</span>
        </button>
        <button onclick="setView('codex')" id="nav-codex" class="flex flex-col items-center gap-1 transition-colors">
            <i data-lucide="library" class="w-6 h-6"></i><span class="text-[8px] font-black uppercase">Codex</span>
        </button>
    </nav>

    <script>
        const WEST = { 'A': 'ア', 'B': 'ש', 'C': 'ジ', 'D': '⊣', 'E': 'え', 'F': 'ε', 'G': '↸', 'H': 'チ', 'I': 'ꮦ', 'J': 'Б', 'K': 'ᓭ', 'L': '⎓', 'M': 'ꮏ', 'N': 'ք', 'O': 'ꝋ', 'P': '∷', 'Q': 'פ', 'R': 'ꮭ', 'S': '⋊', 'T': 'ꭴ', 'U': 'µ', 'V': 'ᓵ', 'W': 'ꮑ', 'X': 'є', 'Y': 'よ', 'Z': 'չ' };
        const EAST = { 'A': 'а', 'B': 'в', 'C': 'Ж', 'D': 'г', 'E': 'э', 'F': 'з', 'G': 'д', 'H': 'х', 'I': 'и', 'J': 'Б', 'K': 'с', 'L': 'ф', 'M': 'т', 'N': 'п', 'O': 'ꝋ', 'P': 'р', 'Q': 'פ', 'R': 'ꮭ', 'S': 'к', 'T': 'ꭴ', 'U': 'у', 'V': 'ᓵ', 'W': 'н', 'X': 'є', 'Y': 'й', 'Z': 'չ' };
        const SPOKEN = { 'A': 'A', 'B': 'V', 'C': 'ZH', 'D': 'G', 'E': 'E', 'F': 'Z', 'G': 'D', 'H': 'H', 'I': 'I', 'J': 'B', 'K': 'S', 'L': 'F', 'M': 'T', 'N': 'P', 'O': 'O', 'P': 'R', 'Q': 'Q', 'R': 'L', 'S': 'K', 'T': 'M', 'U': 'U', 'V': 'C', 'W': 'N', 'X': 'X', 'Y': 'Y', 'Z': 'Z' };

        const ATLAS = {
            1: { title: "Make Introductions", icon: "user", 
                 vocab: [{w:'HELLO',d:'Greeting'},{w:'NAME',d:'Identity'},{w:'FRIEND',d:'Ally'},{w:'AM',d:'Be(1st)'},{w:'ARE',d:'Be(2nd)'},{w:'KIND',d:'Nice'},{w:'GOOD',d:'Safe'},{w:'THANKS',d:'Thanks'}, {w: 'THIS',d: 'This'}, {w: 'GOODBYE',d: 'Goodbye'}, {w:'NICE',d:'Pleasant'},{w: 'MEET',d: 'Encounter'},{w:'NEW',d:'New'},{w:'HE',d:'Male pronoun'},{w:'SHE',d:'Female pronoun'},{w:'MOM',d:'Mother'},{w:'DAD',d:'FATHER'}],
                 sentences: ["I AM ELIAS.", "YOU ARE SARAH.", "SARAH IS MY FRIEND.", "HELLO, MY NAME IS ELIAS.", "WELCOME, THIS IS SARAH.", "THANK YOU, ELIAS.", "WELCOME, ELIAS.", "HELLO, I AM ELIAS AND THIS IS MY FRIEND SARAH.", "NICE TO MEET YOU.", "HELLO, NICE TO MEET YOU!", "YOU ARE MY NEW FRIEND.", "SHE IS MY NEW FRIEND.", "THIS IS MY DAD.", "DAD, THIS IS MY NEW FRIEND SARAH.", "HELLO, DAD!", "HELLO, MOM!", "THANK YOU, MOM!", "MOM, THIS IS MY NEW FRIEND ELIAS."],
                 story: { title: "The new friendship", chat: [
                     {s:"Elias",l:"HELLO, I AM ELIAS"},
                     {s:"Sarah",l:"HELLO ELIAS, I AM SARAH"},
                     {s:"Elias",l:"YOU ARE MY NEW FRIEND"},
                     {s:"Sarah",l:"YES, NICE TO MEET YOU"},
                     {s:"Elias",l:"GOODBYE"}
                 ] }
            },
            2: { title: "Motion", icon: "activity", 
                 vocab: [{w:'HEAD',d:'Top'},{w:'HAND',d:'Grab'},{w:'LEG',d:'Walk'},{w:'RUN',d:'Fast'},{w:'WALK',d:'Slow'},{w:'STOP',d:'Stay'},{w:'FAST',d:'High Speed'},{w:'STRONG',d:'Strong'}, {w: 'JUMP',d:'Jump'}, {w:'LIKE',d:'Enjoy'}, {w:'COOL',d:'Awesome'}, {w:'BETTER',d:'More good'},{w:'TOO',d:'Also'},{w:'HIKE',d:'Walk through nature'},{w:'OFTEN',d:'A lot'},{w:'WEEK',d:'Seven days'},{w:'MONDAY',d:'Day of the week'},{w:'TUESDAY',d:'Day of the week'},{w:'WEDNESDAY',d:'Day of the week'},{w:'THURSDAY',d:'Day of the week'},{w:'FRIDAY',d:'Day of the week'},{w:'SATURDAY',d:'Day of the week'},{w:'SUNDAY',d:'Day of the week'},{w:'EVERY',d:'Every'}],
                 sentences: ["KAEL RUNS FAST.", "MIRA WALKS SLOW.", "STOP JUMPING.", "MY BODY IS STRONG.", "HELLO MIRA, DO YOU LIKE TO WALK?", "KAEL RUNS EVERY DAY.", "MIRA LIKES TO WALK.", "KAEL IS WALKING TO THE CITY.", "COOL, I LIKE WALKING, TOO.", "KAEL IS VERY STRONG.", "DO YOU HIKE OFTEN?", "I LIKE HIKING", "KAEL HIKES EVERY WEEK.", "I RUN EVERY SUNDAY.", "MIRA WALKS EVERY MONDAY AND HIKES EVERY FRIDAY.", "MY MOM LIKES TO WALK", "MY DAD HIKES EVERY WEDNESDAY."],
                 story: { title: "Discussing exercising hobbies.", chat: [
                     {s:"Kael",l:"DO YOU LIKE TO WALK?"},
                     {s:"Mira",l:"YES, I LIKE WALKING, AND YOU?"},
                     {s:"Kael",l:"I LIKE RUNNING BETTER."},
                     {s:"Mira",l:"COOL."},
                     {s:"Kael",l:"I RUN EVERY MONDAY."}
                 ] }
            },
            3: { title: "Nature", icon: "sun", 
                 vocab: [{w:'TREE',d:'Plant'},{w:'RIVER',d:'Water'},{w:'SUN',d:'Star'},{w:'SKY',d:'Above'},{w:'DARK',d:'Dim'},{w:'GREEN',d:'Nature'},{w:'EARTH',d:'Ground'},{w:'LIGHT',d:'Light'},{w:'VERY',d:'Very'},{w:'TALL',d:'Tall'},{w:'WOW',d:'Expression of amazement'},{w:'ANIMAL',d:'Animal'},{w:'BIRD',d:'FLYING ANIMAL'},{w:'FLOWER',d:'Colorful plant'},{w:'MANY',d:'Lots of'},{w:'BIG',d:'Large'},{w:'PRETTY',d:'BEAUTIFUL'},{w:'COLOR',d:'Color'}],
                 sentences: ["THE SUN IS BRIGHT", "GAIA SEES THE TREE", "THE RIVER IS THERE", "THE SKY IS BLUE.", "THERE ARE MANY FLOWERS.", "THAT BIRD IS BIG!", "THE FLOWERS ARE PRETTY.", "MY MOM LIKES FLOWERS.", "MY DAD LIKES BIRDS.", "THE FLOWERS ARE MANY DIFFERENT COLORS."],
                 story: { title: "Admiring the tree", chat: [
                     {s:"Orion",l:"LOOK AT THAT TREE, GAIA!"},
                     {s:"Gaia",l:"WOW! IT IS VERY TALL."},
                     {s:"Orion",l:"LOOK AT ALL OF THE BIRDS AND FLOWERS."},
                     {s:"Gaia",l:"THE FLOWERS ARE PRETTY."},
                     {s:"Orion",l:"THE LEAVES ARE VERY GREEN."}
                 ] }
            },
            4: { title: "Work & Job", icon: "briefcase", 
                 vocab: [{w:'BOSS',d:'Leader'},{w:'CLERK',d:'Worker'},{w:'OFFICE',d:'Work room'},{w:'TOOL',d:'Useful item'},{w:'BUILD',d:'Create'},{w:'JOB',d:'Task'},{w:'WAGE',d:'Pay'},{w:'DESK',d:'Table'},{w:'PAPER',d:'Sheet'},{w:'PEN',d:'Writer'},{w:'FINISH',d:'Complete'}, {w:'Doctor',d:'Profession'},{w:'TEACHER',d:'Profession'},{w:'WAITER',d:'Profession'}],
                 sentences: ["THE CLERK BUILDS A TOOL", "I WORK AT THE OFFICE", "MY WORK IS IMPORTANT", "MY WAGE IS HIGH", "WHAT IS YOUR JOB?", "MY JOB IS BUILDING TOOLS.", "ARE YOU A DOCTOR?", "YES, I AM A DOCTOR.", "NO, I AM A TEACHER.", "I AM NOT A TEACHER, I AM A WAITER.", "BORIS IS MY TEACHER.", "HELLO, ARE YOU MY TEACHER?", "SHE IS MY NEW TEACHER."],
                 story: { title: "Office Day", chat: [
                     {s:"Supervisor",l:"BUILD THE TOOL."},
                     {s:"Clerk",l:"I AM BUSY AT THE DESK"},
                     {s:"Supervisor",l:"OKAY, FINISH THAT AND THEN DO IT."},
                     {s:"Clerk",l:"THANK YOU."},
                     {s:"Supervisor",l:"GOODBYE."}
                 ] }
            },
            5: { title: "Politics", icon: "shield", 
                 vocab: [{w:'JUDGE',d:'Official'},{w:'KING',d:'Ruler'},{w:'QUEEN',d:'Ruler'},{w:'LAW',d:'Rules'},{w:'VOTE',d:'Choice'},{w:'PEACE',d:'Calm'},{w:'WAR',d:'Fight'},{w:'GUARD',d:'Protect'},{w:'CITIZEN',d:'Person'},{w:'TRUTH',d:'Fact'},{w:'RIGHT',d:'Correct'},{w:'POWER',d:'STRENGTH'},{w:'POLITICS',d:'Politics'},{w:'IDEA',d:'Idea'},{w:'THINK',d:'Think'}],
                 sentences: ["THE KING RULES THE LAND.", "THE LAW IS TRUTH.", "VOTE FOR PEACE.", "JUSTICE IS TRUTH.", "THE WAR IS ALMOST OVER.", "THE KING IS RIGHT.", "THERE IS A NEW LAW.", "THE KING HAS POWER.", "THE KING SAYS THE WAR WILL END SOON, I THINK HE IS RIGHT.", "THE KING AND QUEEN MAKE THE LAWS."],
                 story: { title: "TAlking about politics", chat: [
                     {s:"Citizen 1",l:"DID YOU SEE THE NEW LAW?"},
                     {s:"Citizen 2",l:"YES, I THINK IT WAS A GOOD IDEA."},
                     {s:"Citizen 1",l:"I HOPE WE WILL STAY PEACEFUL."},
                     {s:"Citizen 2",l:"THE KING SAYS THE WAR IS ALMOST OVER."},
                     {s:"Citizen 1",l:"I THINK HE IS RIGHT"}
                 ] }
            },
            6: { title: "CHECKPOINT 1", icon: "scroll", 
                 vocab: [{w:'HELLO',d:'Greeting'},{w:'NAME',d:'Identity'},{w:'FRIEND',d:'Ally'},{w:'AM',d:'Be(1st)'},{w:'ARE',d:'Be(2nd)'},{w:'KIND',d:'Nice'},{w:'GOOD',d:'Safe'},{w:'THANKS',d:'Thanks'}, {w: 'THIS',d: 'This'}, {w: 'GOODBYE',d: 'Goodbye'}, {w:'NICE',d:'Pleasant'},{w: 'MEET',d: 'Encounter'},{w:'NEW',d:'New'},{w:'HE',d:'Male pronoun'},{w:'SHE',d:'Female pronoun'},{w:'MOM',d:'Mother'},{w:'DAD',d:'FATHER'},
                         {w:'HEAD',d:'Top'},{w:'HAND',d:'Grab'},{w:'LEG',d:'Walk'},{w:'RUN',d:'Fast'},{w:'WALK',d:'Slow'},{w:'STOP',d:'Stay'},{w:'FAST',d:'High Speed'},{w:'STRONG',d:'Strong'}, {w: 'JUMP',d:'Jump'}, {w:'LIKE',d:'Enjoy'}, {w:'COOL',d:'Awesome'}, {w:'BETTER',d:'More good'},{w:'TOO',d:'Also'},{w:'HIKE',d:'Walk through nature'},{w:'OFTEN',d:'A lot'},{w:'WEEK',d:'Seven days'},{w:'MONDAY',d:'Day of the week'},{w:'TUESDAY',d:'Day of the week'},{w:'WEDNESDAY',d:'Day of the week'},{w:'THURSDAY',d:'Day of the week'},{w:'FRIDAY',d:'Day of the week'},{w:'SATURDAY',d:'Day of the week'},{w:'SUNDAY',d:'Day of the week'},{w:'EVERY',d:'Every'},
                        {w:'TREE',d:'Plant'},{w:'RIVER',d:'Water'},{w:'SUN',d:'Star'},{w:'SKY',d:'Above'},{w:'DARK',d:'Dim'},{w:'GREEN',d:'Nature'},{w:'EARTH',d:'Ground'},{w:'LIGHT',d:'Light'},{w:'VERY',d:'Very'},{w:'TALL',d:'Tall'},{w:'WOW',d:'Expression of amazement'},{w:'ANIMAL',d:'Animal'},{w:'BIRD',d:'FLYING ANIMAL'},{w:'FLOWER',d:'Colorful plant'},{w:'MANY',d:'Lots of'},{w:'BIG',d:'Large'},{w:'PRETTY',d:'BEAUTIFUL'},{w:'COLOR',d:'Color'},
                        {w:'BOSS',d:'Leader'},{w:'CLERK',d:'Worker'},{w:'OFFICE',d:'Work room'},{w:'TOOL',d:'Useful item'},{w:'BUILD',d:'Create'},{w:'JOB',d:'Task'},{w:'WAGE',d:'Pay'},{w:'DESK',d:'Table'},{w:'PAPER',d:'Sheet'},{w:'PEN',d:'Writer'},{w:'FINISH',d:'Complete'}, {w:'Doctor',d:'Profession'},{w:'TEACHER',d:'Profession'},{w:'WAITER',d:'Profession'},
                        {w:'JUDGE',d:'Official'},{w:'KING',d:'Ruler'},{w:'QUEEN',d:'Ruler'},{w:'LAW',d:'Rules'},{w:'VOTE',d:'Choice'},{w:'PEACE',d:'Calm'},{w:'WAR',d:'Fight'},{w:'GUARD',d:'Protect'},{w:'CITIZEN',d:'Person'},{w:'TRUTH',d:'Fact'},{w:'RIGHT',d:'Correct'},{w:'POWER',d:'STRENGTH'},{w:'POLITICS',d:'Politics'},{w:'IDEA',d:'Idea'},{w:'THINK',d:'Think'},{w:'CURIOSITY',d:'Curiosity'},{w:'BECAUSE',d:'Because'},{w:'COLORFUL',d:'Lots of color'}],
                 sentences: ["I AM ELIAS.", "YOU ARE SARAH.", "SARAH IS MY FRIEND.", "HELLO, MY NAME IS ELIAS.", "WELCOME, THIS IS SARAH.", "THANK YOU, ELIAS.", "WELCOME, ELIAS.", "HELLO, I AM ELIAS AND THIS IS MY FRIEND SARAH.", "NICE TO MEET YOU.", "HELLO, NICE TO MEET YOU!", "YOU ARE MY NEW FRIEND.", "SHE IS MY NEW FRIEND.", "THIS IS MY DAD.", "DAD, THIS IS MY NEW FRIEND SARAH.", "HELLO, DAD!", "HELLO, MOM!", "THANK YOU, MOM!", "MOM, THIS IS MY NEW FRIEND ELIAS.",
                            "KAEL RUNS FAST.", "MIRA WALKS SLOW.", "STOP JUMPING.", "MY BODY IS STRONG.", "HELLO MIRA, DO YOU LIKE TO WALK?", "KAEL RUNS EVERY DAY.", "MIRA LIKES TO WALK.", "KAEL IS WALKING TO THE CITY.", "COOL, I LIKE WALKING, TOO.", "KAEL IS VERY STRONG.", "DO YOU HIKE OFTEN?", "I LIKE HIKING", "KAEL HIKES EVERY WEEK.", "I RUN EVERY SUNDAY.", "MIRA WALKS EVERY MONDAY AND HIKES EVERY FRIDAY.", "MY MOM LIKES TO WALK", "MY DAD HIKES EVERY WEDNESDAY.",
                            "THE SUN IS BRIGHT", "GAIA SEES THE TREE", "THE RIVER IS THERE", "THE SKY IS BLUE.", "THERE ARE MANY FLOWERS.", "THAT BIRD IS BIG!", "THE FLOWERS ARE PRETTY.", "MY MOM LIKES FLOWERS.", "MY DAD LIKES BIRDS.", "THE FLOWERS ARE MANY DIFFERENT COLORS.",
                            "THE CLERK BUILDS A TOOL", "I WORK AT THE OFFICE", "MY WORK IS IMPORTANT", "MY WAGE IS HIGH", "WHAT IS YOUR JOB?", "MY JOB IS BUILDING TOOLS.", "ARE YOU A DOCTOR?", "YES, I AM A DOCTOR.", "NO, I AM A TEACHER.", "I AM NOT A TEACHER, I AM A WAITER.", "BORIS IS MY TEACHER.", "HELLO, ARE YOU MY TEACHER?", "SHE IS MY NEW TEACHER.",
                            "THE KING RULES THE LAND.", "THE LAW IS TRUTH.", "VOTE FOR PEACE.", "JUSTICE IS TRUTH.", "THE WAR IS ALMOST OVER.", "THE KING IS RIGHT.", "THERE IS A NEW LAW.", "THE KING HAS POWER.", "THE KING SAYS THE WAR WILL END SOON, I THINK HE IS RIGHT.", "THE KING AND QUEEN MAKE THE LAWS.", "CURIOSITY IS GOOD."],
                 story: { title: "CHECKPOINT 1", chat: [
                     {s:"Boris",l:"HELLO, MY NAME IS BORIS. I LIKE TO RUN EVERY SUNDAY."},
                     {s:"Hilda",l:"COOL. I LIKE FLOWERS BECAUSE THEY ARE VERY COLORFUL."},
                     {s:"Boris",l:"WHAT IS YOUR JOB? I AM A TEACHER."},
                     {s:"Hilda",l:"I AM A WAITER."},
                     {s:"Boris",l:"THE KING AND QUEEN MADE A NEW LAW, DID YOU SEE?"},
                     {s:"Hilda",l:"YES. I THINK THEY ARE RIGHT."}
                 ] }
            },
            7: { title: "Weather", icon: "waves", 
                 vocab: [{w:'PILOT',d:'Flyer'},{w:'TOWER',d:'Base'},{w:'RAIN',d:'Water'},{w:'SNOW',d:'Ice'},{w:'STORM',d:'Wind'},{w:'HOT',d:'Heat'},{w:'SIGNAL',d:'Comm'},{w:'FLY',d:'Fly'},{w:'LAND',d:'Land'},{w:'SAFE',d:'Safe'}],
                 sentences: ["PILOT SEES THE RAIN", "STORM IS NEAR", "SIGNAL IS GOOD", "GO TO THE TOWER"],
                 story: { title: "Radio Check", chat: [
                     {s:"Pilot",l:"TOWER THE STORM IS NEAR"},
                     {s:"Tower",l:"GO LOW PILOT STAY SAFE"},
                     {s:"Pilot",l:"I SEE THE RAIN NOW"},
                     {s:"Tower",l:"THE SIGNAL IS GOOD"},
                     {s:"Pilot",l:"I LAND AT THE CITY"}
                 ] }
            },
            8: { title: "Trade", icon: "coins", 
                 vocab: [{w:'MERCHANT',d:'Seller'},{w:'BOIR',d:'Coin'},{w:'COST',d:'Value'},{w:'PAY',d:'Give'},{w:'TEN',d:'10'},{w:'ONE',d:'1'},{w:'FOOD',d:'Fuel'},{w:'BUY',d:'Take'},{w:'SELL',d:'Give'},{w:'GOLD',d:'Gold'}],
                 sentences: ["FOOD COSTS TEN BOIR", "I PAY ONE BOIR", "BUY THE GOLD", "MERCHANT SELLS FOOD"],
                 story: { title: "Market Talk", chat: [
                     {s:"Merchant",l:"THE FOOD IS TEN BOIR"},
                     {s:"Buyer",l:"I PAY ONE BOIR ONLY"},
                     {s:"Merchant",l:"NO I SELL FOR TEN"},
                     {s:"Buyer",l:"I BUY THE GOLD BAG"},
                     {s:"Merchant",l:"GOOD I TAKE THE PAY"}
                 ] }
            },
            9: { title: "Navigation", icon: "compass", 
                 vocab: [{w:'CAPTAIN',d:'Boss'},{w:'SAILOR',d:'Worker'},{w:'SHIP',d:'Vessel'},{w:'MAP',d:'Guide'},{w:'WAY',d:'Route'},{w:'CITY',d:'Hub'},{w:'SEA',d:'Water'},{w:'PORT',d:'Harbor'},{w:'GO',d:'Leave'},{w:'LAND',d:'Land'}],
                 sentences: ["CAPTAIN HAS THE MAP", "SHIP GOES FAR", "CITY IS NEAR", "SEA IS BLUE"],
                 story: { title: "Captain Log", chat: [
                     {s:"Captain",l:"SAILOR I HAVE THE MAP"},
                     {s:"Sailor",l:"THE SHIP GOES FAR NOW"},
                     {s:"Captain",l:"GO TO THE CITY PORT"},
                     {s:"Sailor",l:"THE SEA IS BLUE TODAY"},
                     {s:"Captain",l:"GOOD STAY ON THE WAY"}
                 ] }
            },
            10: { title: "World Nations", icon: "flag", 
                  vocab: [{w:'USA',d:'Land'},{w:'CHINA',d:'Land'},{w:'JAPAN',d:'Land'},{w:'WORLD',d:'All'},{w:'BORDER',d:'Edge'},{w:'BIG',d:'Large'},{w:'PEOPLE',d:'Humans'},{w:'MAPMAKER',d:'Artist'},{w:'EXPLORER',d:'Traveler'},{w:'FAR',d:'Far'}],
                  sentences: ["JAPAN IS FAR", "USA IS BIG", "THE WORLD IS ONE", "PEOPLE ARE GOOD"],
                  story: { title: "World Map", chat: [
                      {s:"Explorer",l:"THE WORLD IS ONE TOTAL"},
                      {s:"Mapmaker",l:"JAPAN IS FAR FROM HERE"},
                      {s:"Explorer",l:"I SEE THE CHINA BORDER"},
                      {s:"Mapmaker",l:"USA IS A BIG LAND"},
                      {s:"Explorer",l:"I TRAVEL THE WORLD"}
                  ] }
            },
            11: { title: "Music", icon: "music", 
                  vocab: [{w:'SOLOIST',d:'One'},{w:'CONDUCTOR',d:'Lead'},{w:'DRUM',d:'Beat'},{w:'VIOLIN',d:'String'},{w:'SING',d:'Vocal'},{w:'SONG',d:'Music'},{w:'LOUD',d:'High'},{w:'SOFT',d:'Low'},{w:'PLAY',d:'Act'},{w:'HEAR',d:'Hear'}],
                  sentences: ["I PLAY THE DRUM", "SOLOIST PLAYS VIOLIN", "THE SONG IS LOUD", "HEAR THE MUSIC"],
                  story: { title: "Rehearsal", chat: [
                      {s:"Soloist",l:"THE SONG IS LOUD CONDUCTOR"},
                      {s:"Conductor",l:"PLAY SOFT SONG NOW"},
                      {s:"Soloist",l:"I PLAY VIOLIN"},
                      {s:"Conductor",l:"I HEAR THE GOOD BAND"},
                      {s:"Soloist",l:"HEAR THE MUSIC FLOW"}
                  ] }
            },
            12: { title: "FINAL REVIEW", icon: "zap", 
                  vocab: [{w:'VOICE',d:'Signal'},{w:'MASTER',d:'High'},{w:'SYNC',d:'Align'},{w:'EYEAN',d:'System'},{w:'TOTAL',d:'Whole'},{w:'ALL',d:'Every'},{w:'END',d:'Final'},{w:'PEACE',d:'Calm'},{w:'KNOW',d:'Understand'},{w:'LIFE',d:'Life'}],
                  sentences: ["EYEAN IS REAL", "THE SYNC IS MASTER", "THE END IS NEAR", "PEACE IS TOTAL"],
                  story: { title: "Final Sync", chat: [
                      {s:"Voice",l:"TOTAL SYNC IS MASTER"},
                      {s:"Master",l:"EYEAN IS THE END"},
                      {s:"Voice",l:"I KNOW THE ALL"},
                      {s:"Master",l:"PEACE IS REAL TOTAL"},
                      {s:"Voice",l:"SYNC IS DONE"}
                  ] }
            }
        };

        let state = {
            view: 'path',
            xp: parseInt(localStorage.getItem('eyean-xp') || 0),
            completed: JSON.parse(localStorage.getItem('eyean-lessons') || '{}'),
            script: 1, // 1 for WEST, 2 for EAST
            session: null,
            finished: false,
            uFinished: false,
            transIn: ''
        };

        function toggleScript() {
            state.script = state.script === 1 ? 2 : 1;
            document.getElementById('script-toggle').innerText = `Script: ${state.script === 1 ? 'West' : 'East'}`;
            render();
        }

        function setView(v) { 
            state.view = v; 
            state.finished = false; 
            state.uFinished = false; 
            render(); 
        }

        function scramble(w) { 
            if (!w) return "";
            if (w.toUpperCase() === 'BOIR') return 'BOIR';
            return w.toUpperCase().split('').map(c => SPOKEN[c] || c).join(''); 
        }

        function scriptify(w, s) { 
            if (!w) return ""; 
            const map = s === 1 ? WEST : EAST; 
            return w.toUpperCase().split('').map(c => map[c] || c).join(''); 
        }

        function isLessonLocked(uId, lIdx) {
            uId = Number(uId); lIdx = Number(lIdx);
            if (uId === 1 && lIdx === 0) return false;
            if (lIdx > 0) return !state.completed[`${uId}-${lIdx - 1}`];
            return !state.completed[`${uId - 1}-9`];
        }

        function initLesson(uId, lIdx) {
            if (isLessonLocked(uId, lIdx)) return;
            const u = ATLAS[uId];
            let exercises = [];
    
            // 1. Vocab Intro (First 4 exercises)
            const offset = (lIdx % 2) * 4;
            u.vocab.slice(offset, offset + 4).forEach(v => {
                exercises.push({ type:'vocab', word:v.w, d:v.d, p:scramble(v.w) });
            });

            // 2. Multiple Sentence Builders (Exercises 5, 6, and 7)
            // We loop 3 times to add 3 different sentences from your library
            for (let i = 0; i < 3; i++) {
                // This picks different sentences based on the lesson index and loop index
                const sIndex = (lIdx + i) % u.sentences.length;
                const s = u.sentences[sIndex];
        
                exercises.push({ 
                    type:'sentence', 
                    en: s, 
                    target: s, 
                    bank: [...s.split(' '), 'VOID', 'DARK', 'REAL'].sort(() => Math.random() - 0.5) 
                });
            }

            // 3. Story or Cloze (Exercise 8)
            if (lIdx === 4 || lIdx === 9) {
                exercises.push({ type:'story_read', story: u.story });
            }

            // 4. Fill remaining slots with random vocab to reach a total of 10
            while(exercises.length < 10) {
                const v = u.vocab[Math.floor(Math.random() * u.vocab.length)];
                exercises.push({ type:'vocab', word:v.w, d:v.d, p:scramble(v.w) });
            }

            state.session = { exercises, index: 0, feedback: null, uId, lIdx, selection: [] };
            state.view = 'lesson';
            render();
        }

        function clearSelection() {
            if (state.session.feedback) return;
            state.session.selection = [];
            render();
        }

        function handleAction() {
            const s = state.session;
            const cur = s.exercises[s.index];

            if (s.feedback) {
                if (s.index < 9) {
                    s.index++;
                    s.feedback = null;
                    s.selection = [];
                    render();
                } else {
                    finishLesson();
                }
                return;
            }

            // Logic for checking
            if (cur.type === 'vocab' || cur.type === 'story_read') {
                s.feedback = 'correct';
            } else if (cur.type === 'sentence') {
                const ans = s.selection.join(' ');
                s.feedback = ans === cur.target ? 'correct' : 'wrong';
            } else if (cur.type === 'cloze') {
                // Handled by direct click in template for simplicity or we can add state
                s.feedback = s.selection[0] === cur.target ? 'correct' : 'wrong';
            }
            render();
        }

        function finishLesson() {
            state.xp += 50; 
            state.completed[`${state.session.uId}-${state.session.lIdx}`] = true;
            localStorage.setItem('eyean-xp', state.xp);
            localStorage.setItem('eyean-lessons', JSON.stringify(state.completed));
            if (state.session.lIdx === 9) state.uFinished = true; else state.finished = true;
            createConfetti(state.uFinished ? 80 : 30);
            render();
        }

        function createConfetti(n) {
            for(let i=0; i<n; i++) {
                const c = document.createElement('div');
                c.className = 'confetti'; c.style.left = Math.random()*100 + '%';
                c.style.backgroundColor = ['#38bdf8', '#f59e0b', '#ffffff'][Math.floor(Math.random()*3)];
                c.style.animationDuration = (Math.random()*2+2)+'s'; document.body.appendChild(c);
                setTimeout(() => c.remove(), 4000);
            }
        }

        function render() {
            const container = document.getElementById('app-content');
            const nav = document.getElementById('footer-nav');
            document.getElementById('xp-val').innerText = state.xp;
            nav.classList.toggle('hidden', state.view === 'lesson');
            
            // Nav Highlighting
            ['path', 'translator', 'codex'].forEach(id => {
                const el = document.getElementById('nav-' + id);
                if (el) {
                    el.classList.toggle('text-sky-400', state.view === id);
                    el.classList.toggle('text-slate-600', state.view !== id);
                }
            });

            if (state.finished || state.uFinished) {
                container.innerHTML = `
                <div class="animate-in flex flex-col items-center justify-center min-h-[70vh] text-center p-4">
                    ${state.uFinished ? `
                        <div class="relative mb-8 badge-radiant p-8 rounded-full"><i data-lucide="medal" class="w-32 h-32 text-amber-400 drop-shadow-glow"></i></div>
                        <h2 class="text-5xl font-black italic uppercase text-white mb-2">Unit Mastered</h2>
                        <p class="text-amber-500 font-bold mb-8">+100 XP BONUS</p>
                    ` : `
                        <i data-lucide="trophy" class="w-32 h-32 text-sky-400 mb-8 drop-shadow-glow bounce-slow"></i>
                        <h2 class="text-4xl font-black uppercase italic mb-2">Lesson Clear!</h2>
                        <p class="text-amber-500 font-bold mb-8">+50 XP</p>
                    `}
                    <button onclick="setView('path')" class="w-full bg-white text-slate-950 py-6 rounded-3xl font-black uppercase text-xl shadow-2xl">Continue Voyage</button>
                </div>`;
            } else if (state.view === 'path') {
                let html = `<div class="space-y-12 pt-4">`;
                Object.keys(ATLAS).forEach(uId => {
                    const unit = ATLAS[uId];
                    html += `
                    <div class="relative">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-14 h-14 bg-slate-900 border border-white/10 rounded-2xl flex items-center justify-center text-sky-400 shadow-xl">
                                <i data-lucide="${unit.icon}"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-black uppercase text-slate-500 tracking-widest">Unit ${uId}</p>
                                <h2 class="text-2xl font-black uppercase italic">${unit.title}</h2>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                    `;
                    for (let i = 0; i < 10; i++) {
                        const locked = isLessonLocked(uId, i);
                        const done = state.completed[`${uId}-${i}`];
                        html += `
                        <button onclick="initLesson(${uId}, ${i})" 
                            class="relative p-6 rounded-[2rem] border-2 transition-all text-left overflow-hidden ${done ? 'bg-sky-500/10 border-sky-500/40 text-sky-400' : locked ? 'bg-slate-900/50 border-white/5 opacity-40' : 'bg-slate-900 border-white/10 hover:border-sky-500/50'}">
                            <span class="block text-2xl font-black mb-1">${i + 1}</span>
                            <span class="text-[9px] font-black uppercase opacity-60">${done ? 'Mastered' : locked ? 'Encrypted' : 'Decrypt'}</span>
                        </button>
                        `;
                    }
                    html += `</div></div>`;
                });
                container.innerHTML = html + `</div>`;
            } else if (state.view === 'lesson') {
                const s = state.session;
                const cur = s.exercises[s.index];
                const progress = ((s.index) / 10) * 100;

                let content = '';
                if (cur.type === 'vocab') {
                    content = `
                        <div class="animate-in flex flex-col items-center justify-center text-center py-12">
                            <div class="text-[80px] leading-none mb-10 eyean-font text-sky-400 drop-shadow-glow">${scriptify(cur.word, state.script)}</div>
                            <div class="bg-slate-900/50 px-4 py-2 rounded-full text-xs font-black tracking-widest text-slate-500 mb-6 uppercase">Pronunciation: ${cur.p}</div>
                            <h2 class="text-5xl font-black uppercase italic mb-2">${cur.word}</h2>
                            <p class="text-slate-400 text-lg">"${cur.d}"</p>
                        </div>
                    `;
                } else if (cur.type === 'sentence') {
                    content = `
                        <div class="animate-in space-y-8">
                            <h3 class="text-sm font-black uppercase text-slate-500 tracking-widest">Translate to English</h3>
                            <div class="bg-slate-900 border border-white/10 p-10 rounded-[3rem] text-center shadow-inner">
                                <div class="text-4xl eyean-font text-sky-400 leading-relaxed">${scriptify(cur.en, state.script)}</div>
                            </div>
                            <div class="min-h-[60px] flex flex-wrap gap-2 justify-center border-b border-white/5 pb-4">
                                ${s.selection.map(w => `<div class="bg-sky-500 text-slate-950 px-4 py-2 rounded-xl font-bold uppercase shadow-lg">${w}</div>`).join('')}
                            </div>
                            <div class="flex flex-wrap gap-2 justify-center">
                                ${cur.bank.map(w => `<button onclick="handleWordClick('${w}')" class="word-chip bg-slate-900 border-b-4 border-black px-4 py-2 rounded-xl font-bold uppercase">${w}</button>`).join('')}
                                <button onclick="clearSelection()" class="px-4 py-2 text-slate-500 font-bold uppercase text-xs">Clear</button>
                            </div>
                        </div>
                    `;
                } else if (cur.type === 'story_read') {
                    content = `
                        <div class="animate-in space-y-6">
                            <div class="text-center mb-8">
                                <h3 class="text-xs font-black uppercase text-sky-500 tracking-tighter">Transmission Intercepted</h3>
                                <h2 class="text-3xl font-black uppercase italic">${cur.story.title}</h2>
                            </div>
                            <div class="space-y-4">
                                ${cur.story.chat.map(m => `
                                    <div class="flex flex-col ${m.s === cur.story.chat[0].s ? 'items-start' : 'items-end'}">
                                        <span class="text-[8px] font-black uppercase text-slate-500 mb-1 px-2">${m.s}</span>
                                        <div class="bg-slate-900 border border-white/10 p-4 rounded-2xl max-w-[80%]">
                                            <div class="eyean-font text-sky-400 mb-2">${scriptify(m.l, state.script)}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (cur.type === 'cloze') {
                    content = `
                        <div class="animate-in space-y-8 text-center">
                            <h3 class="text-xl font-bold italic mb-8">${cur.en}</h3>
                            <div class="grid grid-cols-1 gap-4">
                                ${cur.opts.map(opt => `
                                    <button onclick="state.session.selection=['${opt}']; handleAction()" class="bg-slate-900 border-2 border-white/10 hover:border-sky-500 p-6 rounded-3xl font-black uppercase text-xl transition-all">
                                        ${opt}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="flex flex-col min-h-[80vh]">
                        <div class="w-full bg-slate-900 h-2 rounded-full overflow-hidden mb-10 shadow-inner">
                            <div class="bg-sky-500 h-full transition-all duration-500" style="width: ${progress}%"></div>
                        </div>
                        <div class="flex-1">${content}</div>
                        <div class="fixed bottom-0 left-0 right-0 p-6 verify-bar flex flex-col gap-4">
                            ${s.feedback ? `
                                <div class="animate-in p-4 rounded-2xl flex items-center gap-4 ${s.feedback === 'correct' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}">
                                    <i data-lucide="${s.feedback === 'correct' ? 'check-circle' : 'alert-circle'}"></i>
                                    <span class="font-black uppercase italic">${s.feedback === 'correct' ? 'Sequence Valid' : 'Corrupted Data'}</span>
                                </div>
                            ` : ''}
                            <button onclick="handleAction()" class="w-full py-6 rounded-3xl font-black uppercase text-xl shadow-2xl transition-all ${s.feedback === 'wrong' ? 'bg-rose-500 text-white' : 'bg-sky-500 text-slate-950'}">
                                ${s.feedback ? 'Continue' : 'Verify'}
                            </button>
                        </div>
                    </div>
                `;
            } else if (state.view === 'translator') {
                container.innerHTML = `
                <div class="animate-in space-y-8 pt-4">
                    <div class="flex flex-col gap-2">
                        <h2 class="text-4xl font-black uppercase italic">Universal Translator</h2>
                        <p class="text-slate-500 text-sm font-medium">Instant localized Eyean-to-English conversion.</p>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-slate-500 tracking-widest px-1">Source: English</label>
                        <textarea oninput="state.transIn = this.value; renderTrans();" placeholder="ENTER TRANSMISSION..." class="w-full bg-slate-900 border border-white/10 rounded-[2rem] p-6 h-32 focus:border-sky-500/50 outline-none transition-all text-xl font-bold uppercase"></textarea>
                    </div>

                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase text-sky-500 tracking-widest px-1">Output: Eyean Script</label>
                        <div id="trans-out" class="bg-sky-500/5 border-2 border-sky-500/20 rounded-[2.5rem] p-8 min-h-[12rem] flex items-center justify-center text-center">
                            <div id="trans-text" class="eyean-font text-4xl break-words text-sky-400 leading-relaxed"></div>
                        </div>
                    </div>

                    <div class="p-6 bg-slate-900/50 rounded-3xl border border-white/5 text-center">
                        <p class="text-[10px] font-black text-slate-600 uppercase mb-2">Translation Protocol</p>
                        <p class="text-xs text-slate-400">Eyean is a phonetic cipher. Capitalization is maintained for proper nouns. Punctuation is ignored in the current version of the Lab.</p>
                    </div>
                </div>`;
            } else if (state.view === 'codex') {
                let allVocab = [];
                Object.values(ATLAS).forEach(u => allVocab = [...allVocab, ...u.vocab]);
                container.innerHTML = `
                <div class="animate-in space-y-8 pt-4">
                    <h2 class="text-4xl font-black uppercase italic">The Codex</h2>
                    <div class="grid grid-cols-1 gap-3">
                        ${allVocab.map(v => `
                            <div class="flex items-center justify-between p-5 bg-slate-900 border border-white/5 rounded-2xl">
                                <div>
                                    <div class="eyean-font text-2xl text-sky-400 leading-none mb-1">${scriptify(v.w, state.script)}</div>
                                    <div class="text-xs font-black uppercase tracking-widest text-slate-600">${scramble(v.w)}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-black uppercase text-white">${v.w}</div>
                                    <div class="text-[10px] italic text-slate-500">${v.d}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
            
            lucide.createIcons();
        }

        function renderTrans() {
            const out = document.getElementById('trans-text');
            if(out) out.innerText = state.transIn.toUpperCase().split(' ').map(w => scriptify(w, state.script)).join(' ');
        }

        window.onload = () => { render(); };
    </script>
</body>
</html>
